-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

-- regression test for https://github.com/digital-asset/daml/pull/14080
module TestExceptionAndContractKey where

import DA.Assert ((===))
import DA.Optional (isSome)
import DA.Exception (throw, GeneralError(..))
import Daml.Script

template K
  with
    sig: Party
  where
    signatory sig
    key sig: Party
    maintainer key

template Op
  with sig: Party
  where
    signatory sig
    choice Go: Bool
      with cid: ContractId K
      controller sig
      do
        exercise cid Archive
        try do
          None <- lookupByKey @K sig
          throw (GeneralError "")
        catch (GeneralError _) -> pure ()
        result <- lookupByKey @K sig
        pure $ isSome result


test : Script ()
test = script do
  alice <- allocateParty "alice"
  cid <- submit alice $ createCmd (K alice)
  op <- submit alice $ createCmd (Op alice)
  r <- submit alice $ exerciseCmd op (Go cid)
  r === False


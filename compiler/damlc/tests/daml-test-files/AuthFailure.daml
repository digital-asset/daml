-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates.
-- All rights reserved.

module AuthFailure where

import Daml.Script
import ScriptAssertHelpers

-- Tests for various(all) different forms of authorization failure detected during execution.
-- Five kinds of authorization failure are tested here.
-- Two others (NoSignatories and NoControllers) are tested in separate files, because the expected error message doesn't contain any indication of which testcase causes it.

template TheContract1
  with
    s : Party
  where
    signatory s

-- @ERROR failed due to a missing authorization from 'Ivy-t1'
t1_CreateMissingAuthorization : Script ()
t1_CreateMissingAuthorization = script do
  mach <- allocateParty "Mach-t1"
  ivy <- allocateParty "Ivy-t1"
  mach `submit` createCmd (TheContract1 with s = ivy)
  abort "t1 finished"

template TheContract2
  with
    s : Party
    m : Party
    id : Int
  where
    signatory s
    key (m, id) : (Party, Int)
    maintainer key._1

-- @ERROR failed due to that some parties are maintainers but not signatories: 'Bob-t2'
t2_MaintainersNotSubsetOfSignatories : Script ()
t2_MaintainersNotSubsetOfSignatories = script do
  alice <- allocateParty "Alice-t2"
  bob <- allocateParty "Bob-t2"
  alice `submit` createCmd (TheContract2 with s = alice; m = bob; id = 100)
  abort "t2 finished"

template TheContract3
  with
    s : Party
  where
    signatory s

template TheContractBuilder3
  with
    s : Party
    c : Party
  where
    signatory s
    observer c
    choice TheChoice : ContractId TheContract3
      with s2 : Party
      controller c
      do create TheContract3 with s = s2

t3_QueryMissingAuthorization : Script ()
t3_QueryMissingAuthorization = script do
  alice <- allocateParty "Alice-t3"
  bob <- allocateParty "Bob-t3"
  builder <- alice `submit`
    createCmd (TheContractBuilder3 with s = alice; c = bob)
  -- note: we use `builder` so `cid` is visible to bob, although he is not a stakeholder
  cid <- bob `submit`
    exerciseCmd builder TheChoice with s2 = alice
  bob `cantSee` cid

template TheContract4
  with
    ss : [Party]
    ms : [Party]
    os : [Party]
    id : Int
  where
    signatory ss
    key (ms, id) : ([Party], Int)
    maintainer key._1
    observer os

{-
Previously:

--- @ERROR failed due to a missing authorization from 'Alice-t4'
t4_LookupByKeyMissingAuthorization = scenario do
  alice <- getParty "Alice-t4"
  bob <- getParty "Bob-t4"
  submit alice $ do
    create (TheContract4 with ss = [alice]; ms = [alice]; os = [bob]; id = 100)
  submit bob $ do
    lookupByKey @TheContract4 ([alice],100)
    abort "t4 finished"

Why does this fail? It doesn't fail when converted to scripts, as from my perspective - shouldn't.
bob is explicitly an observer of the contract with that key, why should he not be able to look it up?
-}


-- t4_QueryByKeyMissingAuthorization : Script ()
-- t4_QueryByKeyMissingAuthorization = script do
--   alice <- allocateParty "Alice-t4"
--   bob <- allocateParty "Bob-t4"
--   alice `submit` createCmd (TheContract4 with ss = [alice]; ms = [alice]; os = [bob]; id = 100)
--   cantSeeKey @TheContract4 bob ([alice],100)

template TheContract5
  with
    s : Party
  where
    signatory s
    choice TheChoice5 : () with
        cs : [Party]
      controller cs
      do
        return ()

-- @ERROR failed due to a missing authorization from 'Bob-t5'
t5_ExerciseMissingAuthorization : Script ()
t5_ExerciseMissingAuthorization = script do
  alice <- allocateParty "Alice-t5"
  bob <- allocateParty "Bob-t5"
  cid <- alice `submit` createCmd (TheContract5 with s = alice)
  alice `submit` exerciseCmd cid TheChoice5 with cs = [bob]
  abort "t5 finished"

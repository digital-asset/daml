# Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

load("@os_info//:os_info.bzl", "is_intel", "is_windows")
load(
    "//bazel_tools:scala.bzl",
    "da_scala_benchmark_jmh",
    "da_scala_binary",
    "da_scala_library",
    "da_scala_test",
    "da_scala_test_suite",
    "default_scalacopts",
    "lf_scalacopts",
    "lf_scalacopts_stricter",
)

da_scala_library(
    name = "validation",
    srcs = glob(
        ["src/main/**/*.scala"],
        exclude = ["src/main/**/validation/UpgradeCheckMain.scala"],
    ),
    scala_deps = [
        "@maven//:org_scalaz_scalaz_core",
    ],
    scalacopts = lf_scalacopts_stricter,
    tags = ["maven_coordinates=com.daml:daml-lf-validation:__VERSION__"],
    visibility = [
        "//canton:__subpackages__",
        "//canton-3x:__subpackages__",
        "//compiler/script-service:__subpackages__",
        "//daml-lf:__subpackages__",
    ],
    deps = [
        "//daml-lf/data",
        "//daml-lf/language",
        "//libs-scala/scala-utils",
    ],
)

da_scala_library(
    name = "upgrade-check-main",
    srcs = glob(["src/main/**/validation/UpgradeCheckMain.scala"]),
    scala_deps = [
        "@maven//:org_scalaz_scalaz_core",
        "@maven//:org_typelevel_cats_core",
        "@maven//:org_typelevel_cats_kernel",
    ],
    scalacopts = lf_scalacopts_stricter,
    unused_dependency_checker_mode = "off",
    visibility = ["//visibility:public"],
    deps = [
        "//canton:community_base",
        "//canton:community_ledger_ledger-api-core",
        "//canton:community_ledger_ledger-common",
        "//canton:community_util-logging",
        "//canton:base_daml-errors",
        "//canton:ledger_api_proto_scala",
        "//daml-lf/archive:daml_lf_archive_proto_java",
        "//daml-lf/archive:daml_lf_archive_reader",
        "//daml-lf/data",
        "//daml-lf/language",
        "//daml-lf/validation",
        "//libs-scala/contextualized-logging",
        "//libs-scala/scala-utils",
        "//observability/metrics",
        "@maven//:com_typesafe_scala_logging_scala_logging_2_13",
        "@maven//:org_slf4j_slf4j_api",
    ],
)

da_scala_library(
    name = "validation-test-lib",
    srcs = glob(["src/test/**/SpecUtil.scala"]),
    scala_deps = [
        "@maven//:org_scalactic_scalactic",
    ],
    scalacopts = lf_scalacopts_stricter,
    deps = [
        ":validation",
        "//daml-lf/language",
        "//daml-lf/parser",
    ],
)

da_scala_library(
    name = "upgrade-test-lib",
    srcs =
        glob(
            [
                "src/test/scala/**/upgrade/UpgradesSpecBase.scala",
                "src/test/scala/**/upgrade/UpgradesSpecUtil.scala",
                "src/test/scala/**/upgrade/UpgradesCheckSpecUtil.scala",
            ],
        ) +
        #  we depend on sources to avoid pushing a canton artifact to maven
        [
            "//canton:community_admin-api_proto_scala",
        ],
    scala_deps = [
        "@maven//:org_scalactic_scalactic",
        "@maven//:org_scalatest_scalatest_core",
        "@maven//:org_scalatest_scalatest_matchers_core",
        "@maven//:org_scalatest_scalatest_shouldmatchers",
        "@maven//:org_scalatest_scalatest_wordspec",
        "@maven//:org_apache_pekko_pekko_actor",
        "@maven//:org_apache_pekko_pekko_stream",
    ],
    scaladoc = False,
    unused_dependency_checker_mode = "off",
    visibility = ["//visibility:public"],
    deps = [
        "//:sdk-version-scala-lib",
        "//bazel_tools/runfiles:scala_runfiles",
        "//canton:community_admin-api",
        "//canton:community_ledger_ledger-common",
        "//canton:community_util-logging",
        "//canton:base_grpc-utils",
        "//canton:ledger_api_proto_scala",
        "//daml-assistant/daml-sdk:sdk",
        "//daml-lf/archive:daml_lf_archive_proto_java",
        "//daml-lf/archive:daml_lf_archive_reader",
        "//daml-lf/archive/encoder",
        "//daml-lf/data",
        "//daml-lf/encoder",
        "//daml-lf/language",
        "//daml-lf/parser",
        "//libs-scala/crypto",
        "//libs-scala/ledger-resources",
        "//libs-scala/ports",
        "//libs-scala/resources",
        "//libs-scala/rs-grpc-bridge",
        "//libs-scala/scala-utils",
        "//libs-scala/testing-utils",
        "//test-common/canton/it-lib",
        "@maven//:com_typesafe_scala_logging_scala_logging_2_13",
        "@maven//:io_grpc_grpc_netty",
        "@maven//:org_scalatest_scalatest_compatible",
    ],
)

da_scala_test_suite(
    name = "tests",
    size = "large",
    srcs = glob(
        ["src/test/**/*.scala"],
        exclude = [
            "src/test/**/*SpecUtil.scala",
            "src/test/**/upgrade/*",
        ],
    ),
    data = [],
    scala_deps = [],
    scalacopts = lf_scalacopts,
    deps = [
        ":validation",
        ":validation-test-lib",
        "//daml-lf/data",
        "//daml-lf/language",
        "//daml-lf/parser",
        "//daml-lf/stable-packages",
    ],
)

# TODO https://github.com/digital-asset/daml/issues/17254
#  this test should not use canton and be part of the suite above
[
    da_scala_test_suite(
        name = "upgrade-tests",
        size = "large",
        srcs = glob(
            ["src/test/**/upgrade/*.scala"],
            exclude = [
                "src/test/scala/**/upgrade/UpgradesSpecBase.scala",
                "src/test/scala/**/upgrade/UpgradesSpecUtil.scala",
                "src/test/scala/**/upgrade/UpgradesCheckSpecUtil.scala",
            ],
        ),
        data = [
            "//test-common:dar-files-default",
            "//test-common:upgrades-CommonVersionFailure-v1a.dar",
            "//test-common:upgrades-CommonVersionFailure-v1b.dar",
            "//test-common:upgrades-MissingChoice-v1.dar",
            "//test-common:upgrades-MissingChoice-v2.dar",
            "//test-common:upgrades-MissingDataCon-v1.dar",
            "//test-common:upgrades-MissingDataCon-v2.dar",
            "//test-common:upgrades-MissingModule-v1.dar",
            "//test-common:upgrades-MissingModule-v2.dar",
            "//test-common:upgrades-MissingTemplate-v1.dar",
            "//test-common:upgrades-MissingTemplate-v2.dar",
            "//test-common:upgrades-MissingTemplateDifferentPackageName.dar",
            "//test-common:upgrades-RecordFieldsNewNonOptional-v1.dar",
            "//test-common:upgrades-RecordFieldsNewNonOptional-v2.dar",
            "//test-common:upgrades-TemplateAddedChoice-v1.dar",
            "//test-common:upgrades-TemplateAddedChoice-v2.dar",
            "//test-common:upgrades-TemplateChangedKeyType-v1.dar",
            "//test-common:upgrades-TemplateChangedKeyType-v2.dar",
            "//test-common:upgrades-ValidUpgrade-v1.dar",
            "//test-common:upgrades-ValidUpgrade-v2.dar",
            "//test-common:upgrades-EmptyProject-v21.dar",
            "//test-common:upgrades-EmptyProject-v2dev.dar",
            "//test-common:upgrades-ValidParameterizedTypesUpgrade-v1.dar",
            "//test-common:upgrades-ValidParameterizedTypesUpgrade-v2.dar",
            "//test-common:upgrades-ValidKeyTypeEquality-v1.dar",
            "//test-common:upgrades-ValidKeyTypeEquality-v2.dar",
            "//test-common:upgrades-UploadSucceedsWhenDepsAreValidUpgrades-v1.dar",
            "//test-common:upgrades-UploadSucceedsWhenDepsAreValidUpgrades-v2.dar",
            "//test-common:upgrades-UploadSucceedsWhenDepsAreValidUpgradesDep-v1.dar",
            "//test-common:upgrades-UploadSucceedsWhenDepsAreValidUpgradesDep-v2.dar",
            "//test-common:upgrades-UploadFailsWhenDepsAreInvalidUpgrades-v1.dar",
            "//test-common:upgrades-UploadFailsWhenDepsAreInvalidUpgrades-v2.dar",
            "//test-common:upgrades-SucceedsWhenNonSerializableTypesAreIncompatible-v1.dar",
            "//test-common:upgrades-SucceedsWhenNonSerializableTypesAreIncompatible-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradedFieldFromDifferentPackageName-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradedFieldFromDifferentPackageName-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradedFieldPackagesAreNotUpgradable-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradedFieldPackagesAreNotUpgradable-v2.dar",
            "//test-common:upgrades-FailsWhenDepIsInvalidPreviousVersionOfSelf-v1.dar",
            "//test-common:upgrades-FailsWhenDepIsInvalidPreviousVersionOfSelf-v2.dar",
            "//test-common:upgrades-SucceedsWhenDepIsValidPreviousVersionOfSelf-v1.dar",
            "//test-common:upgrades-SucceedsWhenDepIsValidPreviousVersionOfSelf-v2.dar",

            # Ported from DamlcUpgrades.hs
            "//test-common:upgrades-FailsWhenExistingFieldInTemplateChoiceIsChanged-v1.dar",
            "//test-common:upgrades-FailsWhenExistingFieldInTemplateChoiceIsChanged-v2.dar",
            "//test-common:upgrades-FailsWhenExistingFieldInTemplateIsChanged-v1.dar",
            "//test-common:upgrades-FailsWhenExistingFieldInTemplateIsChanged-v2.dar",
            "//test-common:upgrades-FailsWhenNewFieldIsAddedToTemplateChoiceWithoutOptionalType-v1.dar",
            "//test-common:upgrades-FailsWhenNewFieldIsAddedToTemplateChoiceWithoutOptionalType-v2.dar",
            "//test-common:upgrades-FailsWhenNewFieldIsAddedToTemplateWithoutOptionalType-v1.dar",
            "//test-common:upgrades-FailsWhenNewFieldIsAddedToTemplateWithoutOptionalType-v2.dar",
            "//test-common:upgrades-FailsWhenOldFieldIsDeletedFromTemplate-v1.dar",
            "//test-common:upgrades-FailsWhenOldFieldIsDeletedFromTemplate-v2.dar",
            "//test-common:upgrades-FailsWhenOldFieldIsDeletedFromTemplateChoice-v1.dar",
            "//test-common:upgrades-FailsWhenOldFieldIsDeletedFromTemplateChoice-v2.dar",
            "//test-common:upgrades-FailsWhenTemplateAddsKeyType-v1.dar",
            "//test-common:upgrades-FailsWhenTemplateAddsKeyType-v2.dar",
            "//test-common:upgrades-FailsWhenTemplateChangesKeyType-v1.dar",
            "//test-common:upgrades-FailsWhenTemplateChangesKeyType-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateUpgradesKeyType-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateUpgradesKeyType-v2.dar",
            "//test-common:upgrades-FailsWhenTemplateChoiceChangesItsReturnType-v1.dar",
            "//test-common:upgrades-FailsWhenTemplateChoiceChangesItsReturnType-v2.dar",
            "//test-common:upgrades-FailsWhenTemplateRemovesKeyType-v1.dar",
            "//test-common:upgrades-FailsWhenTemplateRemovesKeyType-v2.dar",
            "//test-common:upgrades-SucceedsWhenNewFieldWithOptionalTypeIsAddedToTemplate-v1.dar",
            "//test-common:upgrades-SucceedsWhenNewFieldWithOptionalTypeIsAddedToTemplate-v2.dar",
            "//test-common:upgrades-SucceedsWhenNewFieldWithOptionalTypeIsAddedToTemplateChoice-v1.dar",
            "//test-common:upgrades-SucceedsWhenNewFieldWithOptionalTypeIsAddedToTemplateChoice-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentTemplateHasChanged-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentTemplateHasChanged-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentEnumHasChanged-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentEnumHasChanged-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentStructHasChanged-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentStructHasChanged-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentVariantHasChanged-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceInputArgumentVariantHasChanged-v2.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceReturnsATemplateWhichHasChanged-v1.dar",
            "//test-common:upgrades-SucceedsWhenTemplateChoiceReturnsATemplateWhichHasChanged-v2.dar",
            "//test-common:upgrades-SuccessUpgradingV2ThenV3-v1.dar",
            "//test-common:upgrades-SuccessUpgradingV2ThenV3-v2.dar",
            "//test-common:upgrades-SuccessUpgradingV2ThenV3-v3.dar",
            "//test-common:upgrades-SuccessUpgradingV3ThenV2-v1.dar",
            "//test-common:upgrades-SuccessUpgradingV3ThenV2-v2.dar",
            "//test-common:upgrades-SuccessUpgradingV3ThenV2-v3.dar",
            "//test-common:upgrades-FailsWhenUpgradingV2ThenV3-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradingV2ThenV3-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradingV2ThenV3-v3.dar",
            "//test-common:upgrades-FailsWhenUpgradingV3ThenV2-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradingV3ThenV2-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradingV3ThenV2-v3.dar",

            # More tests ported from DamlcUpgrades.hs
            "//test-common:upgrades-SucceedsWhenATopLevelEnumChanges-v1.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelEnumChanges-v2.dar",
            "//test-common:upgrades-FailsWhenATopLevelRecordAddsANonOptionalField-v1.dar",
            "//test-common:upgrades-FailsWhenATopLevelRecordAddsANonOptionalField-v2.dar",
            "//test-common:upgrades-FailsWhenATopLevelRecordAddsAnOptionalFieldBeforeTheEnd-v1.dar",
            "//test-common:upgrades-FailsWhenATopLevelRecordAddsAnOptionalFieldBeforeTheEnd-v2.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantAddsAFieldToAConstructorsType-v1.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantAddsAFieldToAConstructorsType-v2.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelVariantAddsAnOptionalFieldToAConstructorsType-v1.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelVariantAddsAnOptionalFieldToAConstructorsType-v2.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantAddsAConstructor-v1.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantAddsAConstructor-v2.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantRemovesAConstructor-v1.dar",
            "//test-common:upgrades-FailsWhenATopLevelVariantRemovesAConstructor-v2.dar",
            "//test-common:upgrades-FailsWhenTwoDeeplyNestedTypeSynonymsResolveToDifferentDatatypes-v1.dar",
            "//test-common:upgrades-FailsWhenTwoDeeplyNestedTypeSynonymsResolveToDifferentDatatypes-v2.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelRecordAddsAnOptionalFieldAtTheEnd-v1.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelRecordAddsAnOptionalFieldAtTheEnd-v2.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelTypeSynonymChanges-v1.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelTypeSynonymChanges-v2.dar",
            "//test-common:upgrades-SucceedsWhenTwoDeeplyNestedTypeSynonymsResolveToTheSameDatatypes-v1.dar",
            "//test-common:upgrades-SucceedsWhenTwoDeeplyNestedTypeSynonymsResolveToTheSameDatatypes-v2.dar",

            # More more tests ported from DamlcUpgrades.hs
            "//test-common:upgrades-FailWhenATopLevelEnumChangesChangesTheOrderOfItsConstructors-v1.dar",
            "//test-common:upgrades-FailWhenATopLevelEnumChangesChangesTheOrderOfItsConstructors-v2.dar",
            "//test-common:upgrades-FailWhenATopLevelVariantChangesChangesTheOrderOfItsConstructors-v1.dar",
            "//test-common:upgrades-FailWhenATopLevelVariantChangesChangesTheOrderOfItsConstructors-v2.dar",

            # More more more tests ported from DamlcUpgrades.hs
            "//test-common:upgrades-SucceedsWhenAnInterfaceIsOnlyDefinedInTheInitialPackage-v1.dar",
            "//test-common:upgrades-SucceedsWhenAnInterfaceIsOnlyDefinedInTheInitialPackage-v2.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsDropped-dep.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsDropped-v1.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsDropped-v2.dar",
            "//test-common:upgrades-FailsWhenAnInterfaceIsDefinedInAnUpgradingPackageWhenItWasAlreadyInThePriorPackage-v1.dar",
            "//test-common:upgrades-FailsWhenAnInterfaceIsDefinedInAnUpgradingPackageWhenItWasAlreadyInThePriorPackage-v2.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsAddedSeparateDep-dep.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsAddedSeparateDep-v1.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsAddedSeparateDep-v2.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsAddedUpgradedPackage-v1.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsAddedUpgradedPackage-v2.dar",
            "//test-common:upgrades-SucceedsWhenAnInstanceIsAddedToNewTemplateUpgradedPackage-v1.dar",
            "//test-common:upgrades-SucceedsWhenAnInstanceIsAddedToNewTemplateUpgradedPackage-v2.dar",
            "//test-common:upgrades-SucceedsWhenAnInstanceIsAddedToNewTemplateSeparateDep-v1.dar",
            "//test-common:upgrades-SucceedsWhenAnInstanceIsAddedToNewTemplateSeparateDep-v2.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelVariantAddsAConstructor-v1.dar",
            "//test-common:upgrades-SucceedsWhenATopLevelVariantAddsAConstructor-v2.dar",
            "//test-common:upgrades-FailsWhenDatatypeChangesVariety-v1.dar",
            "//test-common:upgrades-FailsWhenDatatypeChangesVariety-v2.dar",
            "//test-common:upgrades-SucceedsWhenAddingNonOptionalFieldsToUnserializableTypes-v1.dar",
            "//test-common:upgrades-SucceedsWhenAddingNonOptionalFieldsToUnserializableTypes-v2.dar",
            "//test-common:upgrades-SucceedsWhenChangingConstructorOfUnserializableType-v1.dar",
            "//test-common:upgrades-SucceedsWhenChangingConstructorOfUnserializableType-v2.dar",
            "//test-common:upgrades-SucceedsWhenDeletingUnserializableType-v1.dar",
            "//test-common:upgrades-SucceedsWhenDeletingUnserializableType-v2.dar",
            "//test-common:upgrades-FailsWhenMakingTypeUnserializable-v1.dar",
            "//test-common:upgrades-FailsWhenMakingTypeUnserializable-v2.dar",
            "//test-common:upgrades-FailWhenParamCountChanges-v1.dar",
            "//test-common:upgrades-FailWhenParamCountChanges-v2.dar",
            "//test-common:upgrades-SucceedWhenParamNameChanges-v1.dar",
            "//test-common:upgrades-SucceedWhenParamNameChanges-v2.dar",
            "//test-common:upgrades-SucceedWhenPhantomParamBecomesUsed-v1.dar",
            "//test-common:upgrades-SucceedWhenPhantomParamBecomesUsed-v2.dar",
            "//test-common:upgrades-FailsWhenNewerPackagesUsesAnOlderLFVersion-v1.dar",
            "//test-common:upgrades-FailsWhenNewerPackagesUsesAnOlderLFVersion-v2.dar",
            "//test-common:upgrades-SucceedsWhenNewerPackagesUsesANewerLFVersion-v1.dar",
            "//test-common:upgrades-SucceedsWhenNewerPackagesUsesANewerLFVersion-v2.dar",

            # Test for dependency upgrades
            "//test-common:upgrades-FailsWhenDepsDowngradeVersionsWhileUsingDatatypes-dep-v1.dar",
            "//test-common:upgrades-FailsWhenDepsDowngradeVersionsWhileUsingDatatypes-dep-v2.dar",
            "//test-common:upgrades-FailsWhenDepsDowngradeVersionsWhileUsingDatatypes-v1.dar",
            "//test-common:upgrades-FailsWhenDepsDowngradeVersionsWhileUsingDatatypes-v2.dar",
            "//test-common:upgrades-SucceedsWhenDepsDowngradeVersionsWithoutUsingDatatypes-dep-v1.dar",
            "//test-common:upgrades-SucceedsWhenDepsDowngradeVersionsWithoutUsingDatatypes-dep-v2.dar",
            "//test-common:upgrades-SucceedsWhenDepsDowngradeVersionsWithoutUsingDatatypes-v1.dar",
            "//test-common:upgrades-SucceedsWhenDepsDowngradeVersionsWithoutUsingDatatypes-v2.dar",
            "//test-common:upgrades-FailsWhenAnEnumDropsAConstructor-v1.dar",
            "//test-common:upgrades-FailsWhenAnEnumDropsAConstructor-v2.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsReplacedWithADifferentInstanceOfAnIdenticallyNamedInterface-v1.dar",
            "//test-common:upgrades-FailsWhenAnInstanceIsReplacedWithADifferentInstanceOfAnIdenticallyNamedInterface-v2.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependency-dep-v1.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependency-dep-v2.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependency-v1.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependency-v2.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-dep-dep-v1.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-dep-dep-v2.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-dep-v1.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-dep-v2.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-v1.dar",
            "//test-common:upgrades-SucceedsWhenUpgradingADependencyOfAnUpgradedDependency-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-dep-dep-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-dep-dep-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-dep-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-dep-v2.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-v1.dar",
            "//test-common:upgrades-FailsWhenUpgradingAnUnupgradeableDependencyOfAnUpgradedDependency-v2.dar",
            "//test-common:upgrades-SucceedsWhenAnExceptionIsOnlyDefinedInTheInitialPackage-v1.dar",
            "//test-common:upgrades-SucceedsWhenAnExceptionIsOnlyDefinedInTheInitialPackage-v2.dar",
            "//test-common:upgrades-FailsWhenAnExceptionIsDefinedInAnUpgradingPackageWhenItWasAlreadyInThePriorPackage-v1.dar",
            "//test-common:upgrades-FailsWhenAnExceptionIsDefinedInAnUpgradingPackageWhenItWasAlreadyInThePriorPackage-v2.dar",
        ],
        flaky = True,
        scala_deps = [
            "@maven//:org_apache_pekko_pekko_actor",
            "@maven//:org_apache_pekko_pekko_stream",
        ],
        scalacopts = lf_scalacopts,
        deps = [
            ":upgrade-test-lib",
            "//:sdk-version-scala-lib",
            "//bazel_tools/runfiles:scala_runfiles",
            "//canton:community_admin-api",
            "//canton:community_ledger_ledger-common",
            "//canton:community_util-logging",
            "//canton:ledger_api_proto_scala",
            "//daml-lf/archive:daml_lf_archive_proto_java",
            "//daml-lf/archive:daml_lf_archive_reader",
            "//daml-lf/archive/encoder",
            "//daml-lf/data",
            "//daml-lf/encoder",
            "//daml-lf/language",
            "//daml-lf/parser",
            "//daml-lf/validation:upgrade-check-main",
            "//libs-scala/crypto",
            "//libs-scala/ledger-resources",
            "//libs-scala/resources",
            "//libs-scala/rs-grpc-bridge",
            "//libs-scala/scala-utils",
            "//libs-scala/testing-utils",
            "//test-common/canton/it-lib",
            "@maven//:com_google_protobuf_protobuf_java",
        ],
    ),
] if is_intel and not is_windows else []

da_scala_benchmark_jmh(
    name = "typechecking-benchmark",
    srcs = glob(["src/bench/**/*.scala"]),
    data = [
        "//test-common:model-tests-default.dar",
    ],
    scala_deps = [
        "@maven//:org_scalaz_scalaz_core",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//bazel_tools/runfiles:scala_runfiles",
        "//daml-lf/archive:daml_lf_archive_proto_java",
        "//daml-lf/archive:daml_lf_archive_reader",
        "//daml-lf/data",
        "//daml-lf/engine",
        "//daml-lf/ide-ledger",
        "//daml-lf/interpreter",
        "//daml-lf/language",
        "//daml-lf/stable-packages",
        "//daml-lf/transaction",
        "//daml-lf/validation",
        "//test-common:dar-files-default-lib",
        "@maven//:com_google_protobuf_protobuf_java",
    ],
)

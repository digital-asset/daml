-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates.
-- All rights reserved.

-- @WARN -Werror=upgrade-interfaces
-- @WARN -Werror=upgrade-interfaces

module NullCharacter where

import Daml.Script
import DA.Text (fromCodePoints)

data V = V with
  t: Text

interface I where
  viewtype V

template T
  with
    p : Party
    t : Text
    cps: [Int]
  where
    signatory p
    implements I where
      view = V with t = fromCodePoints cps

    choice FromCodePoints: Text
      controller p
      do
        pure (fromCodePoints cps)

template Helper
  with
    p : Party
  where
    signatory p

    choice CreateContractWithNulChar: ContractId T
      controller p
      do create T with p = p; t = fromCodePoints [0]; cps = []

-- @ERROR range=44:1-44:11; Text contains null character
testCreate = script do
  alice <- allocateParty "Alice"
  alice `submit` createAndExerciseCmd (Helper alice) CreateContractWithNulChar

createContract = script do
  alice <- allocateParty "Alice"
  cid <- alice `submit` createCmd (T with p = alice; t = ""; cps = [0])
  pure (alice, cid)

-- @ERROR range=54:1-54:19; Text contains null character
testExerciseResult = script do
  (alice, cid) <- createContract
  alice `submit` exerciseCmd cid FromCodePoints

-- @ERROR range=59:1-59:9; Text contains null character
testView = script do
  (alice, _) <- createContract
  queryInterface @I alice

-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates.
-- All rights reserved.

module LedgerTime where

import DA.Assert ((===), assertDeadlineExceeded, assertWithinDeadline)
import DA.Text (isInfixOf)
import DA.Time
import Daml.Script

template LabeledContract with
    party : Party
    label : Text
  where
    signatory party

    nonconsuming choice CheckLT : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeLT dueBy

    nonconsuming choice CheckLE : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeLE dueBy

    nonconsuming choice CheckGT : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeGT dueBy

    nonconsuming choice CheckGE : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeGE dueBy

    nonconsuming choice CheckWithinDeadline : ()
      with
        deadline: Time
      controller party
      do
        assertWithinDeadline "within-deadline" deadline
        pure ()

    nonconsuming choice CheckDeadlineExceeded : ()
      with
        deadline: Time
      controller party
      do
        assertDeadlineExceeded "deadline-exceeded" deadline
        pure ()

main =
  script do
    alice <- allocateParty "alice"
    cid <- submit alice $ createCmd (LabeledContract alice "test-action")
    timePrev <- getTime
    let
      timeNow = addRelTime timePrev (microseconds 1)
      timeNext = addRelTime timePrev (microseconds 2)
      timeMin = minBound @Time
      timeMax = maxBound @Time

    -- isLedgerTimeLT
    setTime timeNow
    lt0 <- submit alice $ exerciseCmd cid (CheckLT timeNext)
    lt0 === True
    setTime timeNow
    lt1 <- submit alice $ exerciseCmd cid (CheckLT timeNow)
    lt1 === False
    setTime timeNow
    lt2 <- submit alice $ exerciseCmd cid (CheckLT timePrev)
    lt2 === False
    setTime timeNow
    lt3 <- submit alice $ exerciseCmd cid (CheckLT timeMin)
    lt3 === False
    setTime timeNow
    lt4 <- submit alice $ exerciseCmd cid (CheckLT timeMax)
    lt4 === True

    -- isLedgerTimeLE
    setTime timeNow
    le0 <- submit alice $ exerciseCmd cid (CheckLE timeNext)
    le0 === True
    setTime timeNow
    le1 <- submit alice $ exerciseCmd cid (CheckLE timeNow)
    le1 === True
    setTime timeNow
    le2 <- submit alice $ exerciseCmd cid (CheckLE timePrev)
    le2 === False
    setTime timeNow
    le3 <- submit alice $ exerciseCmd cid (CheckLE timeMin)
    le3 === False
    --setTime timeNow
    --le4 <- submit alice $ exerciseCmd cid (CheckLE timeMax)
    --le4 === True

    -- isLedgerTimeGT
    setTime timeNow
    gt0 <- submit alice $ exerciseCmd cid (CheckGT timeNext)
    gt0 === False
    setTime timeNow
    gt1 <- submit alice $ exerciseCmd cid (CheckGT timeNow)
    gt1 === False
    setTime timeNow
    gt2 <- submit alice $ exerciseCmd cid (CheckGT timePrev)
    gt2 === True
    setTime timeNow
    gt3 <- submit alice $ exerciseCmd cid (CheckGT timeMin)
    gt3 === True
    --setTime timeNow
    --gt4 <- submit alice $ exerciseCmd cid (CheckGT timeMax)
    --gt4 === False

    -- isLedgerTimeGE
    setTime timeNow
    ge0 <- submit alice $ exerciseCmd cid (CheckGE timeNext)
    ge0 === False
    setTime timeNow
    ge1 <- submit alice $ exerciseCmd cid (CheckGE timeNow)
    ge1 === True
    setTime timeNow
    ge2 <- submit alice $ exerciseCmd cid (CheckGE timePrev)
    ge2 === True
    setTime timeNow
    ge3 <- submit alice $ exerciseCmd cid (CheckGE timeMin)
    ge3 === True
    setTime timeNow
    ge4 <- submit alice $ exerciseCmd cid (CheckGE timeMax)
    ge4 === False

    -- assertWithinDeadline
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckWithinDeadline timeNext)
    setTime timeNow
    result0 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timeNow)
    case result0 of
      Left (FailureStatusError fsError) | "AssertionFailed" `isInfixOf` fsError.errorId ->
        -- FIXME: intentionally broken test code for Dylan debugging!
        fsError.message === ("Ledger time is strictly before deadline 'within' at " <> show timeNow)
        --fsError.message === ("Ledger time is strictly before deadline 'within-deadline' at " <> show timeNow)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    result1 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timePrev)
    case result1 of
      Left (FailureStatusError fsError) | "AssertionFailed" `isInfixOf` fsError.errorId ->
        fsError.message === ("Ledger time is strictly before deadline 'within-deadline' at " <> show timePrev)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    result2 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timeMin)
    case result2 of
      Left (FailureStatusError fsError) | "AssertionFailed" `isInfixOf` fsError.errorId ->
        fsError.message === ("Ledger time is strictly before deadline 'within-deadline' at " <> show timeMin)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckWithinDeadline timeMax)

    -- assertDeadlineExceeded
    setTime timeNow
    result3 <- trySubmit alice $ exerciseCmd cid (CheckDeadlineExceeded timeNext)
    case result3 of
      Left (FailureStatusError fsError) | "AssertionFailed" `isInfixOf` fsError.errorId ->
        fsError.message === ("Ledger time is at or after deadline 'deadline-exceeded' at " <> show timeNext)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timeNow)
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timePrev)
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timeMin)
    setTime timeNow
    result4 <- trySubmit alice $ exerciseCmd cid (CheckDeadlineExceeded timeMax)
    case result4 of
      Left (FailureStatusError fsError) | "AssertionFailed" `isInfixOf` fsError.errorId ->
        fsError.message === ("Ledger time is at or after deadline 'deadline-exceeded' at " <> show timeMax)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"

    pure ()

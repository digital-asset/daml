-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates.
-- All rights reserved.

module LedgerTime where

import DA.Assert ((===), assertDeadlineExceeded, assertWithinDeadline)
import DA.Text (isInfixOf)
import DA.Time
import Daml.Script

template LabeledContract with
    party : Party
    label : Text
  where
    signatory party

    nonconsuming choice CheckLT : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeLT dueBy

    nonconsuming choice CheckLE : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeLE dueBy

    nonconsuming choice CheckGT : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeGT dueBy

    nonconsuming choice CheckGE : Bool
      with
        dueBy: Time
      controller party
      do
        isLedgerTimeGE dueBy

    nonconsuming choice CheckWithinDeadline : ()
      with
        deadline: Time
      controller party
      do
        assertWithinDeadline "within-deadline" deadline
        pure ()

    nonconsuming choice CheckDeadlineExceeded : ()
      with
        deadline: Time
      controller party
      do
        assertDeadlineExceeded "deadline-exceeded" deadline
        pure ()

main =
  script do
    alice <- allocateParty "alice"
    cid <- submit alice $ createCmd (LabeledContract alice "test-action")
    timePrev <- getTime
    let
      timeNow = addRelTime timePrev (microseconds 1)
      timeNext = addRelTime timePrev (microseconds 2)
      timeMin = minBound @Time
      timeMax = maxBound @Time

    -- isLedgerTimeLT
    setTime timeNow
    TimeBoundedResult lt0 (Some lt0LB) (Some lt0UB) <- extSubmit alice $ exerciseCmd cid (CheckLT timeNext)
    lt0 === True
    lt0LB === timeMin
    lt0UB === timeNow
    setTime timeNow
    TimeBoundedResult lt1 (Some lt1LB) (Some lt1UB) <- extSubmit alice $ exerciseCmd cid (CheckLT timeNow)
    lt1 === False
    lt1LB === timeNow
    lt1UB === timeMax
    setTime timeNow
    TimeBoundedResult lt2 (Some lt2LB) (Some lt2UB) <- extSubmit alice $ exerciseCmd cid (CheckLT timePrev)
    lt2 === False
    lt2LB === timePrev
    lt2UB === timeMax
    setTime timeNow
    TimeBoundedResult lt3 (Some lt3LB) (Some lt3UB) <- extSubmit alice $ exerciseCmd cid (CheckLT timeMin)
    lt3 === False
    lt3LB === timeMin
    lt3UB === timeMax
    setTime timeNow
    TimeBoundedResult lt4 (Some lt4LB) (Some lt4UB) <- extSubmit alice $ exerciseCmd cid (CheckLT timeMax)
    lt4 === True
    lt4LB === timeMin
    subTime timeMax lt4UB === microseconds 1

    -- isLedgerTimeLE
    setTime timeNow
    TimeBoundedResult le0 (Some le0LB) (Some le0UB) <- extSubmit alice $ exerciseCmd cid (CheckLE timeNext)
    le0 === True
    le0LB === timeMin
    le0UB === timeNext
    setTime timeNow
    TimeBoundedResult le1 (Some le1LB) (Some le1UB) <- extSubmit alice $ exerciseCmd cid (CheckLE timeNow)
    le1 === True
    le1LB === timeMin
    le1UB === timeNow
    setTime timeNow
    TimeBoundedResult le2 (Some le2LB) (Some le2UB) <- extSubmit alice $ exerciseCmd cid (CheckLE timePrev)
    le2 === False
    le2LB === timeNow
    le2UB === timeMax
    setTime timeNow
    TimeBoundedResult le3 (Some le3LB) (Some le3UB) <- extSubmit alice $ exerciseCmd cid (CheckLE timeMin)
    le3 === False
    subTime le3LB timeMin === microseconds 1
    le3UB === timeMax
    setTime timeNow
    resultLE0 <- trySubmit alice $ exerciseCmd cid (CheckLE timeMax)
    case resultLE0 of
      Left (FailureStatusError fsError) | "GeneralError" `isInfixOf` fsError.errorId ->
        fsError.message === "Can not compare against the maximum time bound"
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"

    -- isLedgerTimeGT
    setTime timeNow
    TimeBoundedResult gt0 (Some gt0LB) (Some gt0UB) <- extSubmit alice $ exerciseCmd cid (CheckGT timeNext)
    gt0 === False
    gt0LB === timeMin
    gt0UB === timeNext
    setTime timeNow
    TimeBoundedResult gt1 (Some gt1LB) (Some gt1UB) <- extSubmit alice $ exerciseCmd cid (CheckGT timeNow)
    gt1 === False
    gt1LB === timeMin
    gt1UB === timeNow
    setTime timeNow
    TimeBoundedResult gt2 (Some gt2LB) (Some gt2UB) <- extSubmit alice $ exerciseCmd cid (CheckGT timePrev)
    gt2 === True
    gt2LB === timeNow
    gt2UB === timeMax
    setTime timeNow
    TimeBoundedResult gt3 (Some gt3LB) (Some gt3UB) <- extSubmit alice $ exerciseCmd cid (CheckGT timeMin)
    gt3 === True
    subTime gt3LB timeMin === microseconds 1
    gt3UB === timeMax
    setTime timeNow
    resultGT0 <- trySubmit alice $ exerciseCmd cid (CheckGT timeMax)
    case resultGT0 of
      Left (FailureStatusError fsError) | "GeneralError" `isInfixOf` fsError.errorId ->
        fsError.message === "Can not compare against the maximum time bound"
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"

    -- isLedgerTimeGE
    setTime timeNow
    TimeBoundedResult ge0 (Some ge0LB) (Some ge0UB) <- extSubmit alice $ exerciseCmd cid (CheckGE timeNext)
    ge0 === False
    ge0LB === timeMin
    ge0UB === timeNow
    setTime timeNow
    TimeBoundedResult ge1 (Some ge1LB) (Some ge1UB) <- extSubmit alice $ exerciseCmd cid (CheckGE timeNow)
    ge1 === True
    ge1LB === timeNow
    ge1UB === timeMax
    setTime timeNow
    TimeBoundedResult ge2 (Some ge2LB) (Some ge2UB) <- extSubmit alice $ exerciseCmd cid (CheckGE timePrev)
    ge2 === True
    ge2LB === timePrev
    ge2UB === timeMax
    setTime timeNow
    TimeBoundedResult ge3 (Some ge3LB) (Some ge3UB) <- extSubmit alice $ exerciseCmd cid (CheckGE timeMin)
    ge3 === True
    ge3LB === timeMin
    ge3UB === timeMax
    setTime timeNow
    TimeBoundedResult ge4 (Some ge4LB) (Some ge4UB) <- extSubmit alice $ exerciseCmd cid (CheckGE timeMax)
    ge4 === False
    ge4LB === timeMin
    subTime timeMax ge4UB === microseconds 1

    -- assertWithinDeadline
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckWithinDeadline timeNext)
    setTime timeNow
    resultWD0 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timeNow)
    case resultWD0 of
      Left (FailureStatusError fsError) | fsError.errorId == "stdlib.daml.com/deadline-exceeded" ->
        fsError.message === ("Ledger time is at or past deadline 'within-deadline' at " <> show timeNow)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    resultWD1 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timePrev)
    case resultWD1 of
      Left (FailureStatusError fsError) | fsError.errorId == "stdlib.daml.com/deadline-exceeded" ->
        fsError.message === ("Ledger time is at or past deadline 'within-deadline' at " <> show timePrev)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    resultWD2 <- trySubmit alice $ exerciseCmd cid (CheckWithinDeadline timeMin)
    case resultWD2 of
      Left (FailureStatusError fsError) | fsError.errorId == "stdlib.daml.com/deadline-exceeded" ->
        fsError.message === ("Ledger time is at or past deadline 'within-deadline' at " <> show timeMin)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckWithinDeadline timeMax)

    -- assertDeadlineExceeded
    setTime timeNow
    resultDE0 <- trySubmit alice $ exerciseCmd cid (CheckDeadlineExceeded timeNext)
    case resultDE0 of
      Left (FailureStatusError fsError) | fsError.errorId == "stdlib.daml.com/deadline-not-exceeded" ->
        fsError.message === ("Ledger time is strictly before deadline 'deadline-exceeded' at " <> show timeNext)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timeNow)
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timePrev)
    setTime timeNow
    _ <- submit alice $ exerciseCmd cid (CheckDeadlineExceeded timeMin)
    setTime timeNow
    resultDE1 <- trySubmit alice $ exerciseCmd cid (CheckDeadlineExceeded timeMax)
    case resultDE1 of
      Left (FailureStatusError fsError) | fsError.errorId == "stdlib.daml.com/deadline-not-exceeded" ->
        fsError.message === ("Ledger time is strictly before deadline 'deadline-exceeded' at " <> show timeMax)
      Left e ->
        error $ "failureStatusError incorrect error: " <> show e
      Right _ ->
        error "failureStatusError incorrectly succeeded"

    pure ()

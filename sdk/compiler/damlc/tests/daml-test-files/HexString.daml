-- Copyright (c) 2020, Digital Asset (Switzerland) GmbH and/or its affiliates.
-- All rights reserved.

-- @SUPPORTS-LF-FEATURE DAML_CCTP

module HexString where

import DA.Assert ((===))
import DA.Optional (fromSome)
import DA.Crypto.Text
import Daml.Script

n3: Numeric 3
n3 = 0.123

n7: Numeric 7
n7 = 0.12345_67

n10: Numeric 10
n10 = 0.12345_67890

main =
  script do
    -- `HasToHex Int` and `HasFromHex Int`
    toHex 0 === "00"
    toHex 1 === "01"
    toHex 15 === "0f"
    toHex 16 === "10"
    toHex 255 === "ff"
    toHex 256 === "0100"
    toHex 257 === "0101"
    toHex 3735928559 === "deadbeef"
    fromHex "" === Some 0
    fromHex "00" === Some 0
    fromHex "01" === Some 1
    fromHex "0a" === Some 10
    fromHex "0F" === Some 15
    fromHex "10" === Some 16
    fromHex "Ff" === Some 255
    fromHex "0100" === Some 256
    fromHex "0101" === Some 257
    fromHex "DeadBeef" === Some 3735928559

    -- `HasToHex Text` and `HasFromHex Text`
    toHex "" === ""
    toHex " " === "20"
    toHex "a" === "61"
    toHex "Hello World!" === "48656c6c6f20576f726c6421"
    toHex "DeadBeef" === "4465616442656566"
    fromHex "" === (None: Optional Text)
    fromHex "20" === Some " "
    fromHex "61" === Some "a"
    fromHex "48656c6c6f20576f726c6421" === Some "Hello World!"
    fromHex "4465616442656566" === Some "DeadBeef"

    -- `HasToHex Party` and `HasFromHex Party`
    alice <- allocateParty "Alice"
    Some alice === fromHex(toHex alice)

    -- `HasToHex(Numeric n)` and `HasFromHex(Numeric n)`
    toHex n3 === "302e313233"
    toHex n7 === "302e31323334353637"
    toHex n10 === "302e313233343536373839"
    fromHex "302e313233" === Some n3
    fromHex "302e31323334353637" === Some n7
    fromHex "302e313233343536373839" === Some n10

    -- byteCount
    byteCount "" === 0
    byteCount "00" === 1
    byteCount "0000" === 2
    byteCount "000000" === 3

    -- packHexBytes
    packHexBytes "01" 1 === Some "01"
    packHexBytes "01" 2 === Some "0001"
    packHexBytes "01" 3 === Some "000001"
    packHexBytes "0102" 3 === Some "000102"

    -- sliceHexBytes
    sliceHexBytes "12" 1 2 === Right "12"
    sliceHexBytes "DeadBeef" 2 3 === Right "ad"
    sliceHexBytes "DeadBeef" 3 4 === Right "Be"
    sliceHexBytes "DeadBeef" 2 4 === Right "adBe"
    sliceHexBytes "DeadBeef" 2 5 === Right "adBeef"
    sliceHexBytes "DeadBeef" 3 5 === Right "Beef"
    sliceHexBytes "DeadBeef" 0 2 === Left "Expected start byte to be >= 1, was: 0"
    sliceHexBytes "DeadBeef" 3 6 === Left "Expected end byte to be >= 3 and <= 5 was: 6"
    sliceHexBytes "DeadBeef" 3 2 === Left "Expected end byte to be >= 3 and <= 5 was: 2"

    -- isBytes32Hex, isUInt32Hex, isUInt64Hex, isUInt256Hex
    isBytes32Hex(fromSome(packHexBytes "00" 32)) === True
    isBytes32Hex(fromSome(packHexBytes "DeadBeef" 32)) === True
    isBytes32Hex(fromSome(packHexBytes "00" 31)) === False
    isBytes32Hex(fromSome(packHexBytes "00" 33)) === False
    isUInt32Hex(fromSome(packHexBytes "00" 5)) === True
    isUInt32Hex(fromSome(packHexBytes "000001" 5)) === True
    isUInt32Hex(fromSome(packHexBytes "00" 4)) === False
    isUInt32Hex(fromSome(packHexBytes "00" 6)) === False
    isUInt64Hex(fromSome(packHexBytes "00" 6)) === True
    isUInt64Hex(fromSome(packHexBytes "00" 5)) === False
    isUInt64Hex(fromSome(packHexBytes "00" 7)) === False
    isUInt256Hex(fromSome(packHexBytes "00" 8)) === True
    isUInt256Hex(fromSome(packHexBytes "00" 7)) === False
    isUInt256Hex(fromSome(packHexBytes "00" 9)) === False

    pure ()

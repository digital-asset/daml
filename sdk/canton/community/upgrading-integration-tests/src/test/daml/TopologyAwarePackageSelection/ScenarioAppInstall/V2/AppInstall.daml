-- the single module provided by the `tests-app-install` package.
module AppInstall where

import qualified FeaturedAppRightV1

template AppInstall
  with
    dso : Party -- the DSO party whose Amulet we want to use
    provider: Party
    user: Party
    param1: Decimal
    param2: Optional Decimal -- Added using SCU as part of version `2.0.0` of the `tests-app-install` package.
  where
    signatory provider, user

template AppInstallRequest
  with
    install : AppInstall
  where
    signatory install.user
    observer install.provider

    choice AppInstallRequest_Accept: ContractId AppInstall
      with
        -- featured app right referenced via a Daml API
        -- here we use the actual splice featured app right API, but the test cases will use a dummy implementation thereof
        featuredAppRightCid : ContractId FeaturedAppRightV1.FeaturedAppRight
      controller install.provider
        do
          -- check interface view for matching dso
          -- (and thereby check the 'fetchByInterface' works as expected with topo-aware pkg selection)
          featuredAppRight <- fetch featuredAppRightCid
          let expectedView = FeaturedAppRightV1.FeaturedAppRightView with dso = install.dso, provider = install.provider
          assertMsg "App right view mismatch  " (view featuredAppRight == expectedView)

          -- create featured app activity marker
          result <- exercise featuredAppRightCid FeaturedAppRightV1.FeaturedAppRight_CreateActivityMarker

          -- not expected to be done by an app, but useful for test coverage
          marker <- fetch result.activityMarkerContractId
          let expectedMarkerView = FeaturedAppRightV1.FeaturedAppActivityMarkerView with dso = install.dso, provider = install.provider
          assertMsg "Marker view mismatch" (view marker == expectedMarkerView)

          create install

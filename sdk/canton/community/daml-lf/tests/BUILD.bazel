# Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

load(
    "//rules_daml:daml.bzl",
    "daml_build_test",
    "daml_compile",
)
load(
    "//canton/community/daml-lf/language:daml-lf.bzl",
    "COMPILER_LF_MAJOR_VERSIONS",
    "DEFAULT_LF_VERSION",
    "DEV_LF_VERSION",
    "mangle_for_damlc",
)
load("@os_info//:os_info.bzl", "is_intel")

# TODO(#30144): https://github.com/digital-asset/daml/issues/18457 split
#  Exceptions.daml into templates that use keys and those that don't. Split the
# corresponding test, and re-enable this target.
# [
#     daml_compile(
#         name = "Exceptions-v{}".format(major),
#         srcs = ["Exceptions.daml"],
#         target = DEFAULT_LF_VERSION,
#         visibility = ["//canton/community/daml-lf:__subpackages__"],
#     )
#     for major in LF_MAJOR_VERSIONS
# ]

[
    daml_compile(
        name = "Exceptions-{}".format(mangle_for_damlc(version)),
        srcs = ["src/main/daml/exceptions/Exceptions.daml"],
        target = version,
        visibility = ["//canton/community/daml-lf:__subpackages__"],
    )
    for version in [DEV_LF_VERSION]
]

[
    daml_compile(
        name = "Interfaces-v{}".format(major),
        srcs = ["src/main/daml/interfaces/Interfaces.daml"],
        enable_interfaces = True,
        target = DEFAULT_LF_VERSION,
        visibility = ["//canton/community/daml-lf:__subpackages__"],
    )
    for major in COMPILER_LF_MAJOR_VERSIONS
]

[
    daml_compile(
        name = "InterfaceViews-v{}".format(major),
        srcs = ["src/main/daml/interface-views/InterfaceViews.daml"],
        enable_interfaces = True,
        target = DEFAULT_LF_VERSION,
        visibility = ["//canton/community/daml-lf:__subpackages__"],
    )
    for major in COMPILER_LF_MAJOR_VERSIONS
]

# TODO(#30144) Reimplement this in DamlPlugin
daml_build_test(
    name = "ReinterpretTests-v2",
    project_dir = "src/main/daml/reinterpret",
    visibility = ["//canton/community/daml-lf:__subpackages__"],
)

[
    daml_compile(
        name = "MultiKeys-{}".format(mangle_for_damlc(version)),
        srcs = ["src/main/daml/multi-keys/MultiKeys.daml"],
        target = version,
        visibility = ["//canton/community/daml-lf:__subpackages__"],
    )
    for version in [DEV_LF_VERSION]
]

-- Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

-- This tests that, if the contract id in contract key check is skipped by
-- defining the type that contains a contract id in a separate module, the
-- runtime check is still performed.

module ContractIdInContractKeySkipCheck where

import Daml.Script
import ContractIdInContractKeySkipCheckType (ContractId'(..))

template Contract with
    party : Party
  where
    signatory party

template ContractKeyWithCid with
    party: Party
    cid: ContractId Contract
  where
    signatory [party]

    nonconsuming choice Noop : ()
      controller party
      do pure ()

    key (party, ContractId' cid) : (Party, ContractId' Contract)
    maintainer key._1


-- Helper template to call `lookupByKey` and `fetchByKey`
template Helper
  with
    p : Party
  where
    signatory p
    choice LookupByKey : Optional (ContractId ContractKeyWithCid)
      with
        akey : (Party, ContractId' Contract)
      controller p
      do lookupByKey akey
    choice FetchByKey : (ContractId ContractKeyWithCid, ContractKeyWithCid)
      with
        akey : (Party, ContractId' Contract)
      controller p
      do fetchByKey @ContractKeyWithCid akey

createCrashes: Script ()
createCrashes = script do
  alice <- allocateParty "Alice"
  cid <- alice `submit` createCmd Contract with party = alice
  submitMustFail alice do
    createCmd ContractKeyWithCid with
      party = alice
      cid = cid

fetchCrashes: Script ()
fetchCrashes = script do
  alice <- allocateParty "Alice"
  cid <-  alice `submit` createCmd Contract with party = alice
  submitMustFail alice do createAndExerciseCmd (Helper alice) (FetchByKey (alice, ContractId' cid))

lookupCrashes: Script ()
lookupCrashes = script do
  alice <- allocateParty "Alice"
  cid <-  alice `submit` createCmd Contract with party = alice
  submitMustFail alice do createAndExerciseCmd (Helper alice) (LookupByKey (alice, ContractId' cid))

exerciseCrashes: Script ()
exerciseCrashes = script do
  alice <- allocateParty "Alice"
  cid <-  alice `submit` createCmd Contract with party = alice
  submitMustFail alice do exerciseByKeyCmd @ContractKeyWithCid (alice, ContractId' cid) Noop


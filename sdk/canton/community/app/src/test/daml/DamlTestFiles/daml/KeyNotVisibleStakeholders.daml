-- Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

-- We make this a separate test since itâ€™s annoying to assert
-- which scenario an error message belongs to
-- and here we sidestep this by having the same error for all tests.
module KeyNotVisibleStakeholders where

import Daml.Script

template Keyed
  with
    sig : Party
  where
    signatory sig

    key sig : Party
    maintainer key

template Divulger
  with
    divulgee : Party
    sig : Party
  where
    signatory divulgee
    observer sig

    nonconsuming choice DivulgeKeyed : Keyed
      with
        keyedCid : ContractId Keyed
      controller sig
      do fetch keyedCid

template Delegation
  with
    sig : Party
    divulgee : Party
  where
    signatory sig
    observer divulgee

    choice FetchKeyed
      : (ContractId Keyed, Keyed)
      controller divulgee
      do
        fetchByKey @Keyed sig

    choice LookupKeyed
      : Optional (ContractId Keyed)
      controller divulgee
      do
        lookupByKey sig

divulgeeFetch: Script ()
divulgeeFetch = script do
  sig <- allocateParty "s" -- Signatory
  divulgee <- allocateParty "d" -- Divulgee
  keyedCid <- sig `submit` createCmd Keyed with ..
  divulgercid <- divulgee `submit` createCmd Divulger with ..
  sig `submit` exerciseCmd divulgercid DivulgeKeyed with ..
  submitMustFail divulgee do createAndExerciseCmd (Delegation sig divulgee) FetchKeyed

divulgeeLookup: Script ()
divulgeeLookup = script do
  sig <- allocateParty "s" -- Signatory
  divulgee <- allocateParty "d" -- Divulgee
  keyedCid <- sig `submit` createCmd Keyed with ..
  divulgercid <- divulgee `submit` createCmd Divulger with ..
  sig `submit` exerciseCmd divulgercid DivulgeKeyed with ..
  submitMustFail divulgee do createAndExerciseCmd (Delegation sig divulgee) LookupKeyed

blindFetch: Script ()
blindFetch = script do
  sig <- allocateParty "s" -- Signatory
  divulgee <- allocateParty "d" -- Divulgee
  blind <- allocateParty "b" -- Blind
  keyedCid <- sig `submit` createCmd Keyed with ..
  divulgercid <- divulgee `submit` createCmd Divulger with ..
  sig `submit` exerciseCmd divulgercid DivulgeKeyed with ..
  submitMustFail blind do createAndExerciseCmd (Delegation sig blind) FetchKeyed

blindLookup: Script ()
blindLookup = script do
  sig <- allocateParty "s" -- Signatory
  divulgee <- allocateParty "d" -- Divulgee
  blind <- allocateParty "b" -- Blind
  keyedCid <- sig `submit` createCmd Keyed with ..
  divulgercid <- divulgee `submit` createCmd Divulger with ..
  sig `submit` exerciseCmd divulgercid DivulgeKeyed with ..
  submitMustFail blind do createAndExerciseCmd (Delegation sig blind) LookupKeyed


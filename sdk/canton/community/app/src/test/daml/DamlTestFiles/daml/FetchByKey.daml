-- Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

module FetchByKey where

import Daml.Script

template WithKey
  with
    p : Party
  where
    signatory p
    key p : Party
    maintainer key

template Helper
  with
    p : Party
  where
    signatory p
    choice Fail1 : ()
      controller p
      -- fail when fetching from the ledger
      do fetchByKey @WithKey p
         pure ()
    choice Fail2 : ()
      controller p
      -- fail internally in speedy
      do None <- lookupByKey @WithKey p
         fetchByKey @WithKey p
         pure ()


failLedger : Script ()
failLedger = do 
  p <- allocateParty "p"
  submitMustFail p do createAndExerciseCmd (Helper p) Fail1

failSpeedy : Script ()
failSpeedy = do 
  p <- allocateParty "p"
  submitMustFail p do createAndExerciseCmd (Helper p) Fail2

mustFail : Script ()
mustFail = do 
  p <- allocateParty "p"
  submitMustFail p do createAndExerciseCmd (Helper p) Fail1
  submitMustFail p do createAndExerciseCmd (Helper p) Fail2
-- Copyright (c) 2025 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

-- Check that the compiler bits of contract keys work.
-- @SINCE-LF 1.4
module ContractKeys where

import DA.Assert
import Daml.Script

template AccountInvitation with
    account : Account
  where
    signatory account.bank
    observer account.accountHolder

    choice Accept : ContractId Account
      controller account.accountHolder
      do create account

template Account with
    bank : Party
    accountHolder : Party
    accountNumber : (Text, Int)
  where
    signatory [bank, accountHolder]

    key (bank, accountNumber._1 <> show (this.accountNumber._2)) : (Party, Text)
    maintainer key._1

-- Helper template to call `lookupByKey`.
template Helper
  with
    p : Party
  where
    signatory p
    choice LookupByKey : Optional (ContractId Account)
      with
        akey : (Party, Text)
      controller p
      do lookupByKey akey

test: Script ()
test = script do
    bank <- allocateParty "Bank"
    alice <- allocateParty "Alice"
    let account = Account with
            bank
            accountHolder = alice
            accountNumber = ("CH", 123)
    let accountKey = key account
    invitationCid <- bank `submit` createCmd AccountInvitation with account = account
    accountCid <- alice `submit` exerciseCmd invitationCid Accept


    accountCid' <- bank `submit` createAndExerciseCmd (Helper bank) (LookupByKey accountKey)
    accountCid' === Some accountCid

    Some (accountCid', account') <- queryContractKey @Account bank accountKey
    accountCid' === accountCid
    account' === account

    maintainer @Account accountKey === [bank]

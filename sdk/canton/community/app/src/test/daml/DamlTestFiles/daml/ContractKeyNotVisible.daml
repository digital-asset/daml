-- Copyright (c) 2026 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

module ContractKeyNotVisible where

import DA.Optional()
import Daml.Script

template Foo
  with
    p : Party
  where
    signatory p
    key p : Party
    maintainer key

-- Helper template to call `fetchByKey`.
template Helper
  with
    p : Party
  where
    signatory p
    choice FetchByKey : (ContractId Foo, Foo)
      with
        akey : Party
      controller p
      do fetchByKey @Foo akey

aScenario : Script ()
aScenario = do 
    alice <- allocateParty "Alice"
    bob <- allocateParty "Bob"

    submit bob do createCmd Foo with p = bob
    submitMustFail alice do createAndExerciseCmd (Helper alice) (FetchByKey bob)
    pure ()

aScenarioWithoutHelper : Script ()
aScenarioWithoutHelper = do 
    alice <- allocateParty "Alice"
    bob <- allocateParty "Bob"

    submit bob do createCmd Foo with p = bob
    queryContractKey @Foo alice bob
    pure ()

template Keyed
  with
    sig : Party
  where
    signatory sig

    key sig : Party
    maintainer key

template Divulger
  with
    divulgee : Party
    sig : Party
  where
    signatory divulgee
    observer sig

    nonconsuming choice DivulgeKeyed : Keyed
      with
        keyedCid : ContractId Keyed
      controller sig
      do fetch keyedCid

template Delegation
  with
    sig : Party
    divulgee : Party
  where
    signatory sig
    observer divulgee

    choice LookupKeyed
      : Optional (ContractId Keyed)
      controller divulgee
      do lookupByKey @Keyed sig


divulgeeLookup : Script ()
divulgeeLookup = do 
  sig <- allocateParty "s" -- Signatory
  divulgee <- allocateParty "d" -- Divulgee
  keyedCid <- submit sig do createCmd Keyed with ..
  divulgercid <- submit divulgee do createCmd Divulger with ..
  submit sig do exerciseCmd divulgercid DivulgeKeyed with ..
  -- Divulgee can't do positive lookup with maintainer authority.
  -- Note that the lookup returns `None` so the assertion passes.
  -- If the assertion is changed to `isSome`, the assertion fails,
  -- which means the error message changes. The reason is that the
  -- assertion is checked at interpretation time, before the lookup
  -- is checked at validation time.
  delegationCid <- submit sig $ createCmd (Delegation sig divulgee)
  mcid <- submitMustFail divulgee do exerciseCmd delegationCid LookupKeyed
  pure ()

blindLookup : Script ()
blindLookup = do 
  sig <- allocateParty "s" -- Signatory
  blind <- allocateParty "b" -- Blind
  submit sig do createCmd Keyed with ..
  -- Blind party can't do positive lookup with maintainer authority.
  cid <- submit sig do createCmd (Delegation sig blind)
  submitMustFail blind do exerciseCmd cid LookupKeyed
  pure ()


template LocalKeyVisibility
  with
    sig : Party
    obs : Party
  where
    signatory sig
    observer obs
    choice LocalLookup : ()
      controller obs
      do create (Keyed sig)
         Some _ <- lookupByKey @Keyed sig
         pure ()

    choice LocalFetch : ()
      controller obs
      do create (Keyed sig)
         _ <- fetchByKey @Keyed sig
         pure ()

localLookup : Script ()
localLookup = do 
  p1 <- allocateParty "p1"
  p2 <- allocateParty "p2"
  cid <- submit p1 do createCmd (LocalKeyVisibility p1 p2)
  submit p2 do exerciseCmd cid LocalLookup

localFetch : Script ()
localFetch = do 
  p1 <- allocateParty "p1"
  p2 <- allocateParty "p2"
  cid <- submit p1 do createCmd (LocalKeyVisibility p1 p2)
  submit p2 do exerciseCmd cid LocalFetch

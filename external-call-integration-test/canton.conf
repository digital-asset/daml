# Canton configuration for external call integration test
#
# Key design:
# - participant1 (signatory): HAS extension configured - makes HTTP calls
# - participant2 (observer): NO extension configured - proves stored results work
#
# This proves that observers can process transactions with external calls
# without needing access to the external service.

canton {
  parameters {
    non-standard-config = yes
    alpha-version-support = yes
  }

  # ============================================================
  # SEQUENCER
  # ============================================================
  sequencers {
    sequencer1 {
      storage.type = memory
      public-api.port = 5008
      admin-api.port = 5009
      sequencer.type = BFT
    }
  }

  # ============================================================
  # MEDIATOR
  # ============================================================
  mediators {
    mediator1 {
      storage.type = memory
      admin-api.port = 5007
    }
  }

  # ============================================================
  # PARTICIPANT 1 - SIGNATORY
  # Has extension service configured - will make HTTP calls
  # ============================================================
  participants {
    participant1 {
      storage.type = memory
      admin-api.port = 5012
      ledger-api.port = 5011
      http-ledger-api.port = 5013

      parameters {
        alpha-version-support = yes

        engine {
          # Extension configuration - participant1 can call external services
          extensions {
            test-oracle {
              name = "Test Oracle (Echo Service)"
              host = "127.0.0.1"
              port = 8080
              use-tls = false

              connect-timeout = 2s
              request-timeout = 5s
              max-total-timeout = 10s
              max-retries = 1

              declared-functions = [
                { function-id = "echo", config-hash = "00000000" }
              ]
            }
          }

          extension-settings {
            validate-extensions-on-startup = false
            fail-on-extension-validation-error = false
            echo-mode = false
          }
        }
      }
    }

    # ============================================================
    # PARTICIPANT 2 - OBSERVER
    # NO extension configured - must use stored results
    # If this participant can see transactions with external calls,
    # it proves the stored result replay mechanism works!
    # ============================================================
    participant2 {
      storage.type = memory
      admin-api.port = 5022
      ledger-api.port = 5021
      http-ledger-api.port = 5023

      parameters {
        alpha-version-support = yes

        engine {
          # INTENTIONALLY NO EXTENSIONS CONFIGURED
          # This participant should still be able to process transactions
          # that contain external call results, using stored results.

          extension-settings {
            validate-extensions-on-startup = false
            echo-mode = false
          }
        }
      }
    }
  }
}

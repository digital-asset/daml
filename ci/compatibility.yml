# Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

parameters:
  - name: test_flags
    type: string
    default: ''
  - name: os
    type: string
  - name: push_generic
    type: boolean

steps:
  - bash: ci/dev-env-install.sh
    displayName: 'Build/Install the Developer Environment'
  - bash: ci/configure-bazel.sh
    displayName: 'Configure Bazel for root workspace'
    env:
      IS_FORK: $(System.PullRequest.IsFork)
      # to upload to the bazel cache
      GOOGLE_APPLICATION_CREDENTIALS_CONTENT: $(GOOGLE_APPLICATION_CREDENTIALS_CONTENT)
  - bash: ci/configure-bazel.sh
    displayName: 'Configure Bazel for compatibility workspace'
    env:
      BAZEL_CONFIG_DIR: compatibility
      IS_FORK: $(System.PullRequest.IsFork)
      # to upload to the bazel cache
      GOOGLE_APPLICATION_CREDENTIALS_CONTENT: $(GOOGLE_APPLICATION_CREDENTIALS_CONTENT)
  - bash: |
      set -euo pipefail
      ./compatibility/build-release-artifacts.sh $(Build.StagingDirectory)
    displayName: 'Build release artifacts'
  # At the moment the indirection of first publishing and then downloading
  # artifacts is not strictly necessary. However, we have some artifacts
  # that are platform independent where this could come in handy
  # (e.g. build the typescript libraries on Linux and fetch them on
  # windows) so we use this from the start.
  - task: PublishPipelineArtifact@0
    inputs:
      targetPath: $(Build.StagingDirectory)/sdk-release-tarball.tar.gz
      artifactName: sdk-release-tarball-${{ parameters.os }}.tar.gz
  - ${{ if parameters.push_generic }}:
      - task: PublishPipelineArtifact@0
        inputs:
          targetPath: $(Build.StagingDirectory)/ledger-api-test-tool_deploy.jar
          artifactName: ledger-api-test-tool_deploy.jar
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: sdk-release-tarball-${{ parameters.os }}.tar.gz
      targetPath: compatibility/head_sdk
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: ledger-api-test-tool_deploy.jar
      targetPath: compatibility/head_sdk
  - bash: |
      set -eou pipefail
      ./compatibility/test.sh ${{ parameters.test_flags }}
    displayName: 'Run tests'

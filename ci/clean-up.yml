# Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

steps:
- bash: |
    set -euo pipefail
    # Location of the disk cache for CI servers set in their init files:
    # infra/macos/2-common-box/init.sh:echo "build:darwin --disk_cache=~/.bazel-cache" > ~/.bazelrc
    # infra/vsts_agent_linux_startup.sh:echo "build:linux --disk_cache=~/.bazel-cache" > ~/.bazelrc
    if [ $(df -m . | sed 1d | awk '{print $4}') -lt 30000 ]; then
        echo "$(date -Is) Disk full, cleaning up..."
        disk_cache="$HOME/.bazel-cache"
        rm -rf "$disk_cache"
        echo "$(date -Is) Removed '$disk_cache'."
        local_cache="$HOME/.cache/bazel"
        # This executable does not exist on macOS
        if [ -f "/usr/local/bin/remount_cache" ]; then
            echo "$(date -Is) Removing any dangling Bazel server..."
            for pid in $(lsof "$local_cache" | sed 1d | awk '{print $2}' | sort -u); do
                kill -s KILL $pid
            done
            echo "$(date -Is) Nuking the cache partition..."
            /usr/local/bin/remount_cache
            echo "$(date -Is) Done."
        else
            # This path does not exist on macOS
            if [ -d "$local_cache" ]; then
                echo "$(date -Is) Removing all files under '$local_cache'..."
                chmod -R +w "$local_cache"
                rm -rf "$local_cache"
                echo "$(date -Is) Removed '$local_cache'."
            fi
        fi
    fi
    df -h .
  displayName: clean-up disk cache

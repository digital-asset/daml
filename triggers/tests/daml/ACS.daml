-- Copyright (c) 2019 The DAML Authors. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

daml 1.2
module ACS where

import DA.TextMap (TextMap)
import qualified DA.TextMap as TM

import Daml.Trigger

data TriggerState = TriggerState
  { activeAssets : TextMap Identifier
  , nextCommandId : Int
  , party : Party
  }

initState : Party -> ActiveContracts -> TriggerState
initState party (ActiveContracts events) = TriggerState (foldl updateAcs TM.empty events) 0 party
  where
    updateAcs : TextMap Identifier -> Created -> TextMap Identifier
    updateAcs acs (Created _ cId tId)
      | tId.entityName == "Asset" = TM.insert cId tId acs
      | otherwise = acs

-- | This is a very silly trigger for testing purposes:
-- We track the active Asset contracts (we make no attempts to distinguish different things called Asset)
-- and we create a new AssetMirror contract whenever an Asset contract is created (but we do not archive them).
test : Trigger TriggerState
test = Trigger
  { initialState = initState
  , update = update
  }
  where
    update : Message -> TriggerState -> (TriggerState, Optional Commands,  Text)
    update (MTransaction t) (TriggerState acs nextId party) = case foldl updateEvent ([], acs) (events t) of
      ([], acs) -> (TriggerState acs nextId  party, None, "No command")
      (cmds, acs) ->
        ( TriggerState acs (nextId + 1) party
        , Some $ Commands ("command_" <> show nextId) cmds
        , "Submitted " <> show (length cmds) <> " commands"
        )
      where
        updateEvent : ([Command], TextMap Identifier) -> Event -> ([Command], TextMap Identifier)
        updateEvent (cmds, acs) ev = case ev of
          CreatedEvent (Created _ cId tId)
            | tId.entityName == "Asset" ->
            let createMirror : Command = createCmd (AssetMirror { issuer = party })
            in (createMirror :: cmds, TM.insert cId tId acs)
          ArchivedEvent (Archived _ cId tId)
            | tId.entityName == "Asset" -> (cmds, TM.delete cId acs)
          _ -> (cmds, acs)

template Asset
  with
    issuer : Party
  where
    signatory issuer

template AssetMirror
  with
    issuer : Party
  where
    signatory issuer

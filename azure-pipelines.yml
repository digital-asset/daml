# Azure Pipelines file, see https://aka.ms/yaml

# Enable builds on all branches
trigger:
  # Build every commit as our release process relies on
  # the release process being built alone.
  batch: false
  branches:
    include:
      - master

# Enable PR triggers that target the master branch
pr:
  autoCancel: true # cancel previous builds on push
  branches:
    include:
      - master

jobs:
  - job: Linux
    timeoutInMinutes: 360
    pool:
      name: 'linux-pool'
    steps:
      - template: ci/report-start.yml
      - checkout: self
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

  - job: macOS
    timeoutInMinutes: 360
    pool:
      vmImage: 'macOS-10.14'
    variables:
      nix-cache-key: $(Build.StagingDirectory)/macos-nix-key
      nix-cache-path: /tmp/nix-cache/
      bazel-repo-cache-key: $(Build.StagingDirectory)/bazel-repo-cache-key
      bazel-repo-cache-path: $(Agent.BuildDirectory)/.bazel-cache/repo
    steps:
      - template: ci/report-start.yml
      - checkout: self
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

  - job: Windows
    timeoutInMinutes: 360
    pool:
      name: 'windows-pool'
    steps:
      - template: ci/report-start.yml
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

  - job: perf
    timeoutInMinutes: 60
    pool:
      name: 'linux-pool'
    steps:
      - template: ci/report-start.yml
      - checkout: self
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

  - job: hie_core_stack_86
    timeoutInMinutes: 60
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - template: ci/report-start.yml
      - checkout: self
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml
  - job: Windows_signing
    # Signing is a separate job so that we can make sure that we only sign on releases.
    # Since the release check is run on Linux, we do not have access to that information
    # in the regular Windows step.
    dependsOn: [ "Windows", "Linux" ]
    pool:
      name: 'windows-pool'
    condition: and(succeeded(), eq(dependencies.Linux.outputs['release.has_released'], 'true'))
    variables:
      unsigned-installer: $[ dependencies.Windows.outputs['publish.artifact-unsigned-windows-installer'] ]
    steps:
      - template: ci/report-start.yml
      - checkout: self
        persistCredentials: true
      - task: DownloadPipelineArtifact@0
        inputs:
          artifactName: $(unsigned-installer)
          targetPath: $(Build.StagingDirectory)/
      - bash: |
          set -euo pipefail
          INSTALLER=daml-sdk-$(cat VERSION)-windows.exe
          mv "$(Build.StagingDirectory)/$(unsigned-installer)" "$(Build.StagingDirectory)/$INSTALLER"
          chmod +x "$(Build.StagingDirectory)/$INSTALLER"
          echo "$SIGNING_KEY" | base64 -d > signing_key.pfx
          MSYS_NO_PATHCONV=1 signtool.exe sign '/f' signing_key.pfx '/fd' sha256 '/tr' "http://timestamp.digicert.com" '/v' "$(Build.StagingDirectory)/$INSTALLER"
          rm signing_key.pfx
          echo "##vso[task.setvariable variable=artifact-windows-installer;isOutput=true]$INSTALLER"
          echo "##vso[task.setvariable variable=has_released;isOutput=true]true"
        name: signing
        env:
          SIGNING_KEY: $(microsoft-code-signing)
      - task: PublishPipelineArtifact@0
        inputs:
          targetPath: $(Build.StagingDirectory)/$(signing.artifact-windows-installer)
          artifactName: $(signing.artifact-windows-installer)
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

  - job: release
    dependsOn: [ "Linux", "macOS", "Windows", "Windows_signing", "perf"]
    pool:
      vmImage: "ubuntu-latest"
    condition: and(succeeded(), eq( dependencies.Linux.outputs['release.has_released'], 'true' ), eq( dependencies.macOS.outputs['release.has_released'], 'true' ), eq( dependencies.Windows.outputs['release.has_released'], 'true' ))
    steps:
      - template: ci/report-start.yml
      - checkout: self
        persistCredentials: true
      - template: ci/tell-slack-failed.yml
      - template: ci/report-end.yml

-- Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0


module Test.Intro.Asset.V2.Role where

import Daml.Script

import Intro.Asset.V2
import Intro.Asset.V2.Role

setupRoles = do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  usdbank <- allocateParty "USD_Bank"

  ahia <- submit usdbank do
    createCmd AssetHolderInvite with
      issuer = usdbank
      invitedOwners = [alice]
      signedOwners = []

  ahib <- submit usdbank do
    createCmd AssetHolderInvite with
      issuer = usdbank
      invitedOwners = [bob]
      signedOwners = []

  submit alice do
    exerciseCmd ahia AssetHolderInvite_Accept

  submit bob do
    exerciseCmd ahib AssetHolderInvite_Accept

  return (alice, bob, usdbank)

-- TEST_ISSUANCE_BEGIN
test_issuance = do
  setupResult@(alice, bob, bank) <- setupRoles

  assetCid <- submit bank do
    exerciseByKeyCmd @AssetHolder (AssetHolder bank [alice]) Issue_Asset
      with
        symbol = "USD"
        quantity = 100.0

  Some asset <- queryContractId bank assetCid
  assert (asset == Asset with
      issuer = bank
      owner = [alice]
      symbol = "USD"
      quantity = 100.0
      observers = []
        )

  return (setupResult, assetCid)
-- TEST_ISSUANCE_END

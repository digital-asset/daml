# vim: ft=python
# By default 'network' fails to build on Windows and is very much inhermetic on
# Linux/Darwin. The reasons are described here: https://github.com/FormationAI/hazel/issues/80
#
# In order to work around this we use a cabal-like 'package.bzl' generated on
# Linux ('network-package.bzl') and tweak it depending on the platform.
# * Some modules are not built on Windows (Posix-specific)
# * -Dmingw32_HOST_OS and -Dx86_64_HOST_ARCH are set on Windows
# * the 'unix' dependency is dropped on Windows
# * on all platform we introduce a C dependency on the generated network
#   headers. Those are generated by 'configure' using the proper Bazel CC
#   toolchain.

load("@ai_formation_hazel//third_party/cabal2bazel:bzl/cabal_package.bzl",
        "cabal_haskell_package",
        "hazel_symlink")
load("@hazel_base_repository//:extra-libs.bzl",
        "extra_libs",
        )
load("@os_info//:os_info.bzl", "is_windows")


genrule(
        name = "network-include-gen",
        cmd = "PATH=`dirname $(CC)`:$${PATH} $(location configure) && cp include/HsNetworkConfig.h $@",
        outs = [ "include/HsNetworkConfig.h"],
        srcs = [ "configure", "include/HsNet.h", "include/HsNetworkConfig.h.in", "install-sh", "config.sub", "config.guess", "network.buildinfo.in"],
        toolchains = ["@bazel_tools//tools/cpp:current_cc_toolchain"],
        )

cc_library(
        name = "network-include",
        srcs = [ ":network-include-gen"],
        )

extra_libs_with_headers = extra_libs + {"network-headers": ":network-include"}

load("@com_github_digital_asset_daml//3rdparty/haskell:network-package.bzl", "package")

# Make a buildable target for easier debugging of the package.bzl file
hazel_symlink(
 name = "bzl",
 src = "@com_github_digital_asset_daml//3rdparty/haskell:network-package.bzl",
 out = "package-bzl",
)

cabal_haskell_package(
        package,
        "8.6.5",
        "@io_tweag_rules_haskell_ghc_windows_amd64" if is_windows else "@io_tweag_rules_haskell_ghc-nixpkgs",
        extra_libs_with_headers,
        )
